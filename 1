Sub CreateISINList()
    Dim twDataSheet As Worksheet
    Dim isinListSheet As Worksheet
    Dim twDataTable As ListObject
    Dim isinListTable As ListObject
    Dim twDataRow As ListRow
    Dim isinDict As Object
    Dim isinValue As String
    Dim transactionType As String
    Dim i As Long
    Dim key As Variant

    ' Create a dictionary to store ISINs and transaction types
    Set isinDict = CreateObject("Scripting.Dictionary")
    
    ' Set the worksheets
    Set twDataSheet = ThisWorkbook.Worksheets("TW_Data")
    Set isinListSheet = ThisWorkbook.Worksheets("ISIN List")
    
    ' Set the tables
    Set twDataTable = twDataSheet.ListObjects("TW_Data")
    Set isinListTable = isinListSheet.ListObjects("isin_list")
    
    ' Clear existing data in the isin_list table
    If Not isinListTable.DataBodyRange Is Nothing Then
        isinListTable.DataBodyRange.Delete
    End If
    
    ' Loop through the TW_Data table
    For Each twDataRow In twDataTable.ListRows
        isinValue = Trim(twDataRow.Range(1, 7).Value)  ' Column7 contains ISIN
        transactionType = UCase(Trim(twDataRow.Range(1, 12).Value))  ' Column12 contains transaction type
        
        If isinValue <> "" Then
            If Not isinDict.Exists(isinValue) Then
                ' ISIN not yet added, add it with the transaction type
                isinDict.Add isinValue, transactionType
            Else
                ' ISIN already exists, check if we need to update the transaction type
                If isinDict(isinValue) = "SELL" And transactionType = "BUY" Then
                    ' Prioritize BUY over SELL
                    isinDict(isinValue) = "BUY"
                End If
                ' Otherwise, keep the existing transaction type
            End If
        End If
    Next twDataRow
    
    ' Determine the number of rows needed
    Dim numRows As Long
    numRows = isinDict.Count
    If numRows > 0 Then
        ' Resize the table to fit the new data
        isinListTable.Resize isinListTable.Range.Resize(numRows + 1)
    Else
        ' If no ISINs found, reset the table to only header row
        isinListTable.Resize isinListTable.Range.Resize(1)
    End If
    
    ' Populate the isin_list table
    i = 1
    For Each key In isinDict.Keys
        If isinDict(key) = "BUY" Then
            isinListTable.DataBodyRange(i, isinListTable.ListColumns("Purchases").Index).Value = key
        ElseIf isinDict(key) = "SELL" Then
            isinListTable.DataBodyRange(i, isinListTable.ListColumns("Sales").Index).Value = key
        End If
        i = i + 1
    Next key
    
    MsgBox "ISIN List has been created successfully!", vbInformation
End Sub
