Sub CreateISINList()
    Dim twDataSheet As Worksheet
    Dim isinListSheet As Worksheet
    Dim twDataTable As ListObject
    Dim isinListTable As ListObject
    Dim twDataRow As ListRow
    Dim purchaseISINs As New Collection
    Dim salesISINs As New Collection
    Dim isinValue As String
    Dim transactionType As String
    Dim i As Long
    Dim maxRows As Long

    ' Set the worksheets
    Set twDataSheet = ThisWorkbook.Worksheets("TW_Data")
    Set isinListSheet = ThisWorkbook.Worksheets("ISIN List")

    ' Set the tables
    Set twDataTable = twDataSheet.ListObjects("TW_Data")
    Set isinListTable = isinListSheet.ListObjects("isin_list")

    ' Clear existing data in the isin_list table
    If Not isinListTable.DataBodyRange Is Nothing Then
        isinListTable.DataBodyRange.Delete
    End If

    ' Loop through the TW_Data table and collect ISINs
    Dim isinDict As Object
    Set isinDict = CreateObject("Scripting.Dictionary")

    For Each twDataRow In twDataTable.ListRows
        isinValue = Trim(twDataRow.Range(1, 7).Value)  ' Column7 contains ISIN
        transactionType = UCase(Trim(twDataRow.Range(1, 12).Value))  ' Column12 contains transaction type

        If isinValue <> "" Then
            ' Prioritize Purchases over Sales
            If transactionType = "BUY" Then
                isinDict(isinValue) = "BUY"
            ElseIf transactionType = "SELL" Then
                If Not isinDict.Exists(isinValue) Then
                    isinDict(isinValue) = "SELL"
                End If
            End If
        End If
    Next twDataRow

    ' Separate ISINs into Purchases and Sales collections
    Dim key As Variant
    For Each key In isinDict.Keys
        If isinDict(key) = "BUY" Then
            purchaseISINs.Add key
        ElseIf isinDict(key) = "SELL" Then
            salesISINs.Add key
        End If
    Next key

    ' Determine the number of rows needed
    maxRows = Application.WorksheetFunction.Max(purchaseISINs.Count, salesISINs.Count)
    If maxRows > 0 Then
        ' Resize the table to fit the new data
        isinListTable.Resize isinListTable.Range.Resize(maxRows + 1)
    Else
        ' If no ISINs found, reset the table to only header row
        isinListTable.Resize isinListTable.Range.Resize(1)
    End If

    ' Populate the isin_list table with aligned ISINs
    For i = 1 To maxRows
        If i <= purchaseISINs.Count Then
            isinListTable.DataBodyRange(i, isinListTable.ListColumns("Purchases").Index).Value = purchaseISINs(i)
        End If
        If i <= salesISINs.Count Then
            isinListTable.DataBodyRange(i, isinListTable.ListColumns("Sales").Index).Value = salesISINs(i)
        End If
    Next i

    MsgBox "ISIN List has been created successfully!", vbInformation
End Sub
